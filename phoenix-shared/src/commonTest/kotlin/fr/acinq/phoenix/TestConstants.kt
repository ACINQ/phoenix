/*
 * Copyright 2020 ACINQ SAS
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package fr.acinq.phoenix

import fr.acinq.bitcoin.Block
import fr.acinq.bitcoin.ByteVector
import fr.acinq.lightning.*
import fr.acinq.lightning.blockchain.fee.FeerateTolerance
import fr.acinq.lightning.blockchain.fee.OnChainFeeConf
import fr.acinq.lightning.channel.ChannelStateWithCommitments
import fr.acinq.lightning.crypto.LocalKeyManager
import fr.acinq.lightning.serialization.Serialization
import fr.acinq.lightning.utils.msat
import fr.acinq.lightning.utils.sat
import fr.acinq.lightning.utils.toByteVector32
import kotlinx.coroutines.*
import kotlin.time.Duration
import kotlin.time.ExperimentalTime
import kotlin.time.seconds

object TestConstants {
    val keyManager = LocalKeyManager(Lightning.randomBytes32(), Block.TestnetGenesisBlock.hash)
    val nodeParams = NodeParams(
        keyManager = keyManager,
        alias = "phoenix",
        features = Features(
            Feature.OptionDataLossProtect to FeatureSupport.Mandatory,
            Feature.VariableLengthOnion to FeatureSupport.Optional,
            Feature.PaymentSecret to FeatureSupport.Optional,
            Feature.BasicMultiPartPayment to FeatureSupport.Optional,
            Feature.Wumbo to FeatureSupport.Optional,
            Feature.StaticRemoteKey to FeatureSupport.Optional,
            Feature.TrampolinePayment to FeatureSupport.Optional,
            Feature.AnchorOutputs to FeatureSupport.Optional
        ),
        dustLimit = 546.sat,
        onChainFeeConf = OnChainFeeConf(
            closeOnOfflineMismatch = true,
            updateFeeMinDiffRatio = 0.1,
            feerateTolerance = FeerateTolerance(ratioLow = 0.01, ratioHigh = 100.0)
        ),
        maxHtlcValueInFlightMsat = 150000000L,
        maxAcceptedHtlcs = 30,
        expiryDeltaBlocks = CltvExpiryDelta(144),
        fulfillSafetyBeforeTimeoutBlocks = CltvExpiryDelta(6),
        checkHtlcTimeoutAfterStartupDelaySeconds = 15,
        htlcMinimum = 1000.msat,
        minDepthBlocks = 3,
        toRemoteDelayBlocks = CltvExpiryDelta(144),
        maxToLocalDelayBlocks = CltvExpiryDelta(1000),
        feeBase = 1000.msat,
        feeProportionalMillionth = 10,
        reserveToFundingRatio = 0.01, // note: not used (overridden below)
        maxReserveToFundingRatio = 0.05,
        revocationTimeoutSeconds = 20,
        authTimeoutSeconds = 10,
        initTimeoutSeconds = 10,
        pingIntervalSeconds = 30,
        pingTimeoutSeconds = 10,
        pingDisconnect = true,
        autoReconnect = false,
        initialRandomReconnectDelaySeconds = 5,
        maxReconnectIntervalSeconds = 3600,
        chainHash = Block.TestnetGenesisBlock.hash,
        channelFlags = 1,
        paymentRequestExpirySeconds = 3600,
        multiPartPaymentExpirySeconds = 60,
        minFundingSatoshis = 1000.sat,
        maxFundingSatoshis = 16777215.sat,
        maxPaymentAttempts = 5,
        enableTrampolinePayment = true,
        maxRemoteDustLimit = 600.sat
    )

    // 2 normal channels
    val channel1 = Serialization.deserialize(
        ByteVector("9f781e66722e6163696e712e65636c6169722e6368616e6e656c2e4e6f726d616cbf6c737461746963506172616d73bf6a6e6f6465506172616d73bf6a6b65794d616e616765729f782666722e6163696e712e65636c6169722e63727970746f2e4c6f63616c4b65794d616e61676572bf647365656478403031303130313031303130313031303130313031303130313031303130313031303130313031303130313031303130313031303130313031303130313031303169636861696e48617368784030363232366534363131316130623539636161663132363034336562356262663238633334663361356533333261316663376232623733636631383839313066ffff65616c69617365616c696365686665617475726573bf696163746976617465649fbf67666561747572659f782a66722e6163696e712e65636c6169722e466561747572652e496e697469616c526f7574696e6753796e63bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782d66722e6163696e712e65636c6169722e466561747572652e4f7074696f6e446174614c6f737350726f74656374bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f783366722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573457874656e646564bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e5661726961626c654c656e6774684f6e696f6ebfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e5061796d656e74536563726574bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782766722e6163696e712e65636c6169722e466561747572652e53746174696352656d6f74654b6579bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e416e63686f724f757470757473bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782966722e6163696e712e65636c6169722e466561747572652e5472616d706f6c696e655061796d656e74bfffff67737570706f7274684f7074696f6e616cffffff69647573744c696d697419044c6e6f6e436861696e466565436f6e66bf76636c6f73654f6e4f66666c696e654d69736d61746368f5757570646174654665654d696e44696666526174696ffb3fb999999999999a7066656572617465546f6c6572616e6365bf68726174696f4c6f77fb3fe000000000000069726174696f48696768fb4014000000000000ffff78186d617848746c6356616c7565496e466c696768744d7361741a08f0d180706d6178416363657074656448746c637318647165787069727944656c7461426c6f636b73bf6a756e6465726c79696e67190090ff782066756c66696c6c5361666574794265666f726554696d656f7574426c6f636b73bf6a756e6465726c79696e6706ff6b68746c634d696e696d756dbf646d73617400ff73746f52656d6f746544656c6179426c6f636b73bf6a756e6465726c79696e67190090ff756d6178546f4c6f63616c44656c6179426c6f636b73bf6a756e6465726c79696e671903e8ff6e6d696e4465707468426c6f636b73036766656542617365bf646d7361741a000854d0ff781866656550726f706f7274696f6e616c4d696c6c696f6e74680a7572657365727665546f46756e64696e67526174696ffb3f847ae147ae147b78186d617852657365727665546f46756e64696e67526174696ffb3fa999999999999a78187265766f636174696f6e54696d656f75745365636f6e647314726175746854696d656f75745365636f6e64730a72696e697454696d656f75745365636f6e64730a7370696e67496e74657276616c5365636f6e6473181e7270696e6754696d656f75745365636f6e64730a6e70696e67446973636f6e6e656374f56d6175746f5265636f6e6e656374f47822696e697469616c52616e646f6d5265636f6e6e65637444656c61795365636f6e647305781b6d61785265636f6e6e656374496e74657276616c5365636f6e6473190e1069636861696e486173687840303632323665343631313161306235396361616631323630343365623562626632386333346633613565333332613166633762326237336366313838393130666c6368616e6e656c466c61677301781b7061796d656e74526571756573744578706972795365636f6e6473190e10781d6d756c7469506172745061796d656e744578706972795365636f6e6473183c726d696e46756e64696e675361746f736869731903e8726d617846756e64696e675361746f736869731a00ffffff726d61785061796d656e74417474656d707473056e7472616d706f6c696e654e6f6465bf626964784230326136373731633865323330356164633764343038663534356138353431333639633834376339373934643735613637343436646538643638353031333537656664686f737469616c6963652e636f6d64706f7274192607ff77656e61626c655472616d706f6c696e655061796d656e74f5ff6c72656d6f74654e6f646549647842303339646330653062316432353930356534346664663666386538393735356135653231393638353834306430626331643238643333303866393632386133353835ff6a63757272656e74546970bf65666972737401667365636f6e647900a030313030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303033626133656466643761376231326232376163373263336536373736386636313766633831626333383838613531333233613966623861613462316535653461646165353439346466666666376632303032303030303030ff7663757272656e744f6e436861696e4665657261746573bf726d757475616c436c6f736546656572617465bf6766656572617465192710ff70636c61696d4d61696e46656572617465bf6766656572617465192710ff6b6661737446656572617465bf6766656572617465192710ffff6b636f6d6d69746d656e7473bf6e6368616e6e656c56657273696f6ebf646269747378203030303030303030303030303030303030303030303030303030303030313131ff6b6c6f63616c506172616d73bf666e6f6465496478423033616630656436303532636632386436373036363535343962633836663462373231633966646233303964343063353866353831316636333936366530303564306e66756e64696e674b657950617468bf64706174689f1b00000000ebfadc9f1a3dcd6f851a7af22b8b1a086b02461b00000000a24ca0151b00000000e6123d161a36452b191a317300551b0000000080000001ffff69647573744c696d697419044c78186d617848746c6356616c7565496e466c696768744d7361741a08f0d1806e6368616e6e656c526573657276651927106b68746c634d696e696d756dbf646d73617400ff6b746f53656c6644656c6179bf6a756e6465726c79696e67190090ff706d6178416363657074656448746c6373186468697346756e646572f5781864656661756c7446696e616c5363726970745075624b6579782c3030313437633162353564666134626363333434663534363037623037393062613562373232393831326662686665617475726573bf696163746976617465649fbf67666561747572659f782a66722e6163696e712e65636c6169722e466561747572652e496e697469616c526f7574696e6753796e63bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782d66722e6163696e712e65636c6169722e466561747572652e4f7074696f6e446174614c6f737350726f74656374bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f783366722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573457874656e646564bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e5661726961626c654c656e6774684f6e696f6ebfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e5061796d656e74536563726574bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782766722e6163696e712e65636c6169722e466561747572652e53746174696352656d6f74654b6579bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e416e63686f724f757470757473bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782966722e6163696e712e65636c6169722e466561747572652e5472616d706f6c696e655061796d656e74bfffff67737570706f7274684f7074696f6e616cffffffff6c72656d6f7465506172616d73bf666e6f64654964784230333964633065306231643235393035653434666466366638653839373535613565323139363835383430643062633164323864333330386639363238613335383569647573744c696d69741903e878186d617848746c6356616c7565496e466c696768744d7361741b7fffffffffffffff6e6368616e6e656c52657365727665194e206b68746c634d696e696d756dbf646d7361741903e8ff6b746f53656c6644656c6179bf6a756e6465726c79696e67190090ff706d6178416363657074656448746c637318646d66756e64696e675075624b65797842303239366666643534386662613738376364663131646566633962333232356261373965393332323632303036336565303736306634613836303136666235353531737265766f636174696f6e42617365706f696e747842303264366235626161633539343534653136386130313530316337313437393238356338376363346664383731653334633763643064613431366163306439666532707061796d656e7442617365706f696e7478423032623938633730353232663663393536376635376135323936386166313633306430663162653063323137326439653534316235653133333762316562646637357764656c617965645061796d656e7442617365706f696e7478423032336362313636363732343637353336393636363361363035653261393039653637306637396438336638656337636162636339326164633838316138326263316d68746c6342617365706f696e747842303264323061356365623334333233656662366335383364326136373663633264396365333331616431316565303930376639366230366332323538646262306333686665617475726573bf696163746976617465649fbf67666561747572659f782d66722e6163696e712e65636c6169722e466561747572652e4f7074696f6e446174614c6f737350726f74656374bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782a66722e6163696e712e65636c6169722e466561747572652e496e697469616c526f7574696e6753796e63bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e5661726961626c654c656e6774684f6e696f6ebfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f783366722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573457874656e646564bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782766722e6163696e712e65636c6169722e466561747572652e53746174696352656d6f74654b6579bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e5061796d656e74536563726574bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e416e63686f724f757470757473bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782966722e6163696e712e65636c6169722e466561747572652e5472616d706f6c696e655061796d656e74bfffff67737570706f7274684f7074696f6e616cffffffff6c6368616e6e656c466c616773006b6c6f63616c436f6d6d6974bf65696e646578006473706563bf6568746c63739fff6766656572617465bf6766656572617465191388ff67746f4c6f63616cbf646d7361741a2faf0800ff68746f52656d6f7465bf646d7361741a0bebc200ffff6e7075626c69736861626c65547873bf68636f6d6d69745478bf65696e707574bf686f7574506f696e7478483561396437363430623632616233633939336138623532396431383134313637306166366163343362373739393836643335336438346465313831363139386130303030303030306574784f7574785634303432306630303030303030303030323230303230613438343833626566643664666562303562313432633937643835343732326535326534643435386139623436383434343332626334646265666630663238346c72656465656d53637269707479008e35323231303239366666643534386662613738376364663131646566633962333232356261373965393332323632303036336565303736306634613836303136666235353531323130333865663764353962626330646434376530643561323832643036343465653166653639643833313031633566643931373734363262623131386333356632376335326165ff627478790378303230303030303030303031303135613964373634306236326162336339393361386235323964313831343136373061663661633433623737393938366433353364383464653138313631393861303030303030303030306337613161653830303434613031303030303030303030303030323230303230613563323138363138313432373737616634313734386635363765333962646461333339333866316638633064343432356335343665343162326265313534303461303130303030303030303030303032323030323066363965303434326138316335663065636332303639383963306135616330363732373333396638333063383064643762356462303265633938353136343865343030643033303030303030303030303232303032303737666338323337333537316338656439633864343832353561636139623338363564353262646338653061363739303034643261646530646362393266313837383163306330303030303030303030323230303230363365396637626334623438613837323463336665353065346136613266666465386263373033663164626264303466656431323832663562626434356466613034303034373330343430323230343539356230373237323864316436373964333439643632653838323064343864336564343339303930356639626565306364316636303362663266666165663032323033313961646564613933663838333534656534316333326135393031343534643131393164623037386334363662613764386238326565303838656261663564303134383330343530323231303038393635366263643531643239336236393638626535393630343731386366666439663266306366396162373538396134663431666138623135303637363162303232303362666631643663643432396362636434656563306137646462313532393033633463633630353536353531356264363561653861366237626466323838343430313437353232313032393666666435343866626137383763646631316465666339623332323562613739653933323236323030363365653037363066346138363031366662353535313231303338656637643539626263306464343765306435613238326430363434656531666536396438333130316335666439313737343632626231313863333566323763353261653065376136353230ff6e68746c63547873416e64536967739fffffff6c72656d6f7465436f6d6d6974bf65696e646578006473706563bf6568746c63739fff6766656572617465bf6766656572617465191388ff67746f4c6f63616cbf646d7361741a0bebc200ff68746f52656d6f7465bf646d7361741a2faf0800ffff6474786964784066616461643263386236363265303564383935393035383565663433363061306562656566623766393836663332383861383763653764313131656335373437781872656d6f7465506572436f6d6d69746d656e74506f696e747842303364663565663336643165316330633665326466336666633935616661666533356631646562336465653931306634646334646334316336643362383831323361ff6c6c6f63616c4368616e676573bf6870726f706f7365649fff667369676e65649fff6561636b65649fffff6d72656d6f74654368616e676573bf6870726f706f7365649fff6561636b65649fff667369676e65649fffff6f6c6f63616c4e65787448746c634964007072656d6f74654e65787448746c63496400687061796d656e7473bfff7472656d6f74654e657874436f6d6d6974496e666fbf6572696768747842303234346365316261623536373664323134306435656337356664363563646533336362313162383863663032386262353138653737316363643938393638626531ff6b636f6d6d6974496e707574bf686f7574506f696e7478483561396437363430623632616233633939336138623532396431383134313637306166366163343362373739393836643335336438346465313831363139386130303030303030306574784f7574785634303432306630303030303030303030323230303230613438343833626566643664666562303562313432633937643835343732326535326534643435386139623436383434343332626334646265666630663238346c72656465656d53637269707479008e35323231303239366666643534386662613738376364663131646566633962333232356261373965393332323632303036336565303736306634613836303136666235353531323130333865663764353962626330646434376530643561323832643036343465653166653639643833313031633566643931373734363262623131386333356632376335326165ff781a72656d6f7465506572436f6d6d69746d656e7453656372657473bf6b6b6e6f776e486173686573bfffff696368616e6e656c4964784035613964373634306236326162336339393361386235323964313831343136373061663661633433623737393938366433353364383464653138313631393861ff6e73686f72744368616e6e656c4964bf6269641b0000910000010000ff66627572696564f4736368616e6e656c416e6e6f756e63656d656e74f66d6368616e6e656c557064617465bf697369676e6174757265790080626335663334353237366562303536373631633961373737653930333539333364356562396132306437666263313131613662393935363962393535383434303535316332373736353834343364313161666436633663376561613931633230633262333534393437343835633238656261623530303565353661643866653569636861696e486173687840303632323665343631313161306235396361616631323630343365623562626632386333346633613565333332613166633762326237336366313838393130666e73686f72744368616e6e656c4964bf6269641b0000910000010000ff7074696d657374616d705365636f6e64731a5fcf76a86c6d657373616765466c616773016c6368616e6e656c466c616773016f636c747645787069727944656c7461bf6a756e6465726c79696e67190090ff6f68746c634d696e696d756d4d736174bf646d7361741903e8ff6b666565426173654d736174bf646d7361741a000854d0ff781966656550726f706f7274696f6e616c4d696c6c696f6e7468730a6f68746c634d6178696d756d4d736174bf646d7361741a3b9aca00ffff6d6c6f63616c53687574646f776ef66e72656d6f746553687574646f776ef6ffff").toByteArray(),
        nodeParams
    )
    val channel2 = Serialization.deserialize(
        ByteVector("9f781e66722e6163696e712e65636c6169722e6368616e6e656c2e4e6f726d616cbf6c737461746963506172616d73bf6a6e6f6465506172616d73bf6a6b65794d616e616765729f782666722e6163696e712e65636c6169722e63727970746f2e4c6f63616c4b65794d616e61676572bf647365656478403031303130313031303130313031303130313031303130313031303130313031303130313031303130313031303130313031303130313031303130313031303169636861696e48617368784030363232366534363131316130623539636161663132363034336562356262663238633334663361356533333261316663376232623733636631383839313066ffff65616c69617365616c696365686665617475726573bf696163746976617465649fbf67666561747572659f782a66722e6163696e712e65636c6169722e466561747572652e496e697469616c526f7574696e6753796e63bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782d66722e6163696e712e65636c6169722e466561747572652e4f7074696f6e446174614c6f737350726f74656374bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f783366722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573457874656e646564bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e5661726961626c654c656e6774684f6e696f6ebfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e5061796d656e74536563726574bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782766722e6163696e712e65636c6169722e466561747572652e53746174696352656d6f74654b6579bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e416e63686f724f757470757473bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782966722e6163696e712e65636c6169722e466561747572652e5472616d706f6c696e655061796d656e74bfffff67737570706f7274684f7074696f6e616cffffff69647573744c696d697419044c6e6f6e436861696e466565436f6e66bf76636c6f73654f6e4f66666c696e654d69736d61746368f5757570646174654665654d696e44696666526174696ffb3fb999999999999a7066656572617465546f6c6572616e6365bf68726174696f4c6f77fb3fe000000000000069726174696f48696768fb4014000000000000ffff78186d617848746c6356616c7565496e466c696768744d7361741a08f0d180706d6178416363657074656448746c637318647165787069727944656c7461426c6f636b73bf6a756e6465726c79696e67190090ff782066756c66696c6c5361666574794265666f726554696d656f7574426c6f636b73bf6a756e6465726c79696e6706ff6b68746c634d696e696d756dbf646d73617400ff73746f52656d6f746544656c6179426c6f636b73bf6a756e6465726c79696e67190090ff756d6178546f4c6f63616c44656c6179426c6f636b73bf6a756e6465726c79696e671903e8ff6e6d696e4465707468426c6f636b73036766656542617365bf646d7361741a000854d0ff781866656550726f706f7274696f6e616c4d696c6c696f6e74680a7572657365727665546f46756e64696e67526174696ffb3f847ae147ae147b78186d617852657365727665546f46756e64696e67526174696ffb3fa999999999999a78187265766f636174696f6e54696d656f75745365636f6e647314726175746854696d656f75745365636f6e64730a72696e697454696d656f75745365636f6e64730a7370696e67496e74657276616c5365636f6e6473181e7270696e6754696d656f75745365636f6e64730a6e70696e67446973636f6e6e656374f56d6175746f5265636f6e6e656374f47822696e697469616c52616e646f6d5265636f6e6e65637444656c61795365636f6e647305781b6d61785265636f6e6e656374496e74657276616c5365636f6e6473190e1069636861696e486173687840303632323665343631313161306235396361616631323630343365623562626632386333346633613565333332613166633762326237336366313838393130666c6368616e6e656c466c61677301781b7061796d656e74526571756573744578706972795365636f6e6473190e10781d6d756c7469506172745061796d656e744578706972795365636f6e6473183c726d696e46756e64696e675361746f736869731903e8726d617846756e64696e675361746f736869731a00ffffff726d61785061796d656e74417474656d707473056e7472616d706f6c696e654e6f6465bf626964784230326136373731633865323330356164633764343038663534356138353431333639633834376339373934643735613637343436646538643638353031333537656664686f737469616c6963652e636f6d64706f7274192607ff77656e61626c655472616d706f6c696e655061796d656e74f5ff6c72656d6f74654e6f646549647842303339646330653062316432353930356534346664663666386538393735356135653231393638353834306430626331643238643333303866393632386133353835ff6a63757272656e74546970bf65666972737402667365636f6e647900a030313030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303033626133656466643761376231326232376163373263336536373736386636313766633831626333383838613531333233613966623861613462316535653461646165353439346466666666376632303032303030303030ff7663757272656e744f6e436861696e4665657261746573bf726d757475616c436c6f736546656572617465bf6766656572617465192710ff70636c61696d4d61696e46656572617465bf6766656572617465192710ff6b6661737446656572617465bf6766656572617465192710ffff6b636f6d6d69746d656e7473bf6e6368616e6e656c56657273696f6ebf646269747378203030303030303030303030303030303030303030303030303030303030313131ff6b6c6f63616c506172616d73bf666e6f6465496478423033616630656436303532636632386436373036363535343962633836663462373231633966646233303964343063353866353831316636333936366530303564306e66756e64696e674b657950617468bf64706174689f1b00000000ebfadc9f1a3dcd6f851a7af22b8b1a086b02461b00000000a24ca0151b00000000e6123d161a36452b191a317300551b0000000080000001ffff69647573744c696d697419044c78186d617848746c6356616c7565496e466c696768744d7361741a08f0d1806e6368616e6e656c526573657276651927106b68746c634d696e696d756dbf646d73617400ff6b746f53656c6644656c6179bf6a756e6465726c79696e67190090ff706d6178416363657074656448746c6373186468697346756e646572f5781864656661756c7446696e616c5363726970745075624b6579782c3030313437633162353564666134626363333434663534363037623037393062613562373232393831326662686665617475726573bf696163746976617465649fbf67666561747572659f782a66722e6163696e712e65636c6169722e466561747572652e496e697469616c526f7574696e6753796e63bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782d66722e6163696e712e65636c6169722e466561747572652e4f7074696f6e446174614c6f737350726f74656374bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f783366722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573457874656e646564bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e5661726961626c654c656e6774684f6e696f6ebfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e5061796d656e74536563726574bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782766722e6163696e712e65636c6169722e466561747572652e53746174696352656d6f74654b6579bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e416e63686f724f757470757473bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782966722e6163696e712e65636c6169722e466561747572652e5472616d706f6c696e655061796d656e74bfffff67737570706f7274684f7074696f6e616cffffffff6c72656d6f7465506172616d73bf666e6f64654964784230333964633065306231643235393035653434666466366638653839373535613565323139363835383430643062633164323864333330386639363238613335383569647573744c696d69741903e878186d617848746c6356616c7565496e466c696768744d7361741b7fffffffffffffff6e6368616e6e656c52657365727665194e206b68746c634d696e696d756dbf646d7361741903e8ff6b746f53656c6644656c6179bf6a756e6465726c79696e67190090ff706d6178416363657074656448746c637318646d66756e64696e675075624b65797842303239366666643534386662613738376364663131646566633962333232356261373965393332323632303036336565303736306634613836303136666235353531737265766f636174696f6e42617365706f696e747842303264366235626161633539343534653136386130313530316337313437393238356338376363346664383731653334633763643064613431366163306439666532707061796d656e7442617365706f696e7478423032623938633730353232663663393536376635376135323936386166313633306430663162653063323137326439653534316235653133333762316562646637357764656c617965645061796d656e7442617365706f696e7478423032336362313636363732343637353336393636363361363035653261393039653637306637396438336638656337636162636339326164633838316138326263316d68746c6342617365706f696e747842303264323061356365623334333233656662366335383364326136373663633264396365333331616431316565303930376639366230366332323538646262306333686665617475726573bf696163746976617465649fbf67666561747572659f782d66722e6163696e712e65636c6169722e466561747572652e4f7074696f6e446174614c6f737350726f74656374bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782a66722e6163696e712e65636c6169722e466561747572652e496e697469616c526f7574696e6753796e63bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782b66722e6163696e712e65636c6169722e466561747572652e5661726961626c654c656e6774684f6e696f6ebfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f783366722e6163696e712e65636c6169722e466561747572652e4368616e6e656c52616e676551756572696573457874656e646564bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782766722e6163696e712e65636c6169722e466561747572652e53746174696352656d6f74654b6579bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e5061796d656e74536563726574bfffff67737570706f7274684f7074696f6e616cffbf67666561747572659f782566722e6163696e712e65636c6169722e466561747572652e416e63686f724f757470757473bfffff67737570706f7274694d616e6461746f7279ffbf67666561747572659f782966722e6163696e712e65636c6169722e466561747572652e5472616d706f6c696e655061796d656e74bfffff67737570706f7274684f7074696f6e616cffffffff6c6368616e6e656c466c616773006b6c6f63616c436f6d6d6974bf65696e646578006473706563bf6568746c63739fff6766656572617465bf6766656572617465191388ff67746f4c6f63616cbf646d7361741a6b49d200ff68746f52656d6f7465bf646d7361741a0bebc200ffff6e7075626c69736861626c65547873bf68636f6d6d69745478bf65696e707574bf686f7574506f696e7478486530353438656438663933353861313338336563343561333137636330613432353733303032396231626565393436343365303631313666613063356463633430303030303030306574784f7574785638303834316530303030303030303030323230303230613438343833626566643664666562303562313432633937643835343732326535326534643435386139623436383434343332626334646265666630663238346c72656465656d53637269707479008e35323231303239366666643534386662613738376364663131646566633962333232356261373965393332323632303036336565303736306634613836303136666235353531323130333865663764353962626330646434376530643561323832643036343465653166653639643833313031633566643931373734363262623131386333356632376335326165ff627478790378303230303030303030303031303165303534386564386639333538613133383365633435613331376363306134323537333030323962316265653934363433653036313136666130633564636334303030303030303030306337613161653830303434613031303030303030303030303030323230303230613563323138363138313432373737616634313734386635363765333962646461333339333866316638633064343432356335343665343162326265313534303461303130303030303030303030303032323030323066363965303434326138316335663065636332303639383963306135616330363732373333396638333063383064643762356462303265633938353136343865343030643033303030303030303030303232303032303737666338323337333537316338656439633864343832353561636139623338363564353262646338653061363739303034643261646530646362393266313862383565316230303030303030303030323230303230363365396637626334623438613837323463336665353065346136613266666465386263373033663164626264303466656431323832663562626434356466613034303034383330343530323231303065353335633834366130323963353436376333633763356630366637393537303537333634623134316233316561616531353462343430653238313563613735303232303633656539323337323336336238646234613035613465656336373932323737313562626235303366393661366664303539666338346363393932613763393030313437333034343032323031376461333438323466623531393130653463646162376364643063396439623434363962353064326130323234393936626233343932323137343537646564303232303662356531626132363233633035643632343436396537353636333738336638366136613833373961326130373037366536643366336333623866643334613930313437353232313032393666666435343866626137383763646631316465666339623332323562613739653933323236323030363365653037363066346138363031366662353535313231303338656637643539626263306464343765306435613238326430363434656531666536396438333130316335666439313737343632626231313863333566323763353261653065376136353230ff6e68746c63547873416e64536967739fffffff6c72656d6f7465436f6d6d6974bf65696e646578006473706563bf6568746c63739fff6766656572617465bf6766656572617465191388ff67746f4c6f63616cbf646d7361741a0bebc200ff68746f52656d6f7465bf646d7361741a6b49d200ffff6474786964784037383161336235626239633337363231383137353630366166383537353965306137316632363233653265303237376137346264353439393965633237353864781872656d6f7465506572436f6d6d69746d656e74506f696e747842303364663565663336643165316330633665326466336666633935616661666533356631646562336465653931306634646334646334316336643362383831323361ff6c6c6f63616c4368616e676573bf6870726f706f7365649fff667369676e65649fff6561636b65649fffff6d72656d6f74654368616e676573bf6870726f706f7365649fff6561636b65649fff667369676e65649fffff6f6c6f63616c4e65787448746c634964007072656d6f74654e65787448746c63496400687061796d656e7473bfff7472656d6f74654e657874436f6d6d6974496e666fbf6572696768747842303234346365316261623536373664323134306435656337356664363563646533336362313162383863663032386262353138653737316363643938393638626531ff6b636f6d6d6974496e707574bf686f7574506f696e7478486530353438656438663933353861313338336563343561333137636330613432353733303032396231626565393436343365303631313666613063356463633430303030303030306574784f7574785638303834316530303030303030303030323230303230613438343833626566643664666562303562313432633937643835343732326535326534643435386139623436383434343332626334646265666630663238346c72656465656d53637269707479008e35323231303239366666643534386662613738376364663131646566633962333232356261373965393332323632303036336565303736306634613836303136666235353531323130333865663764353962626330646434376530643561323832643036343465653166653639643833313031633566643931373734363262623131386333356632376335326165ff781a72656d6f7465506572436f6d6d69746d656e7453656372657473bf6b6b6e6f776e486173686573bfffff696368616e6e656c4964784065303534386564386639333538613133383365633435613331376363306134323537333030323962316265653934363433653036313136666130633564636334ff6e73686f72744368616e6e656c4964bf6269641b0000920000010000ff66627572696564f4736368616e6e656c416e6e6f756e63656d656e74f66d6368616e6e656c557064617465bf697369676e6174757265790080306237353164313066613262633462323766613630363162366666366463383966626330306535613139393338633034356263333731343432366335633534363464323731323638333237316537333337353161316165373765323965343764663363626562376137303064643939343532306662313762303530323134356569636861696e486173687840303632323665343631313161306235396361616631323630343365623562626632386333346633613565333332613166633762326237336366313838393130666e73686f72744368616e6e656c4964bf6269641b0000920000010000ff7074696d657374616d705365636f6e64731a5fcf76a96c6d657373616765466c616773016c6368616e6e656c466c616773016f636c747645787069727944656c7461bf6a756e6465726c79696e67190090ff6f68746c634d696e696d756d4d736174bf646d7361741903e8ff6b666565426173654d736174bf646d7361741a000854d0ff781966656550726f706f7274696f6e616c4d696c6c696f6e7468730a6f68746c634d6178696d756d4d736174bf646d7361741a77359400ffff6d6c6f63616c53687574646f776ef66e72656d6f746553687574646f776ef6ffff").toByteArray(),
        nodeParams
    )
}

val rawWalletParams = """
    {
      "testnet": {
        "version": 4,
        "latest_critical_version": 0,
        "trampoline": {
          "v1": {
            "fee_base_sat": 2,
            "fee_percent": 0.001,
            "hops_count": 5,
            "cltv_expiry": 143
          },
          "v2": {
            "attempts": [
              {
                "fee_base_sat": 0,
                "fee_percent": 0,
                "fee_per_millionths": 0,
                "cltv_expiry": 576
              },
              {
                "fee_base_sat": 1,
                "fee_percent": 0.0001,
                "fee_per_millionths": 100,
                "cltv_expiry": 576
              }
            ],
            "nodes": [
              {
                "name": "ACINQ",
                "uri": "03933884aaf1d6b108397e5efe5c86bcf2d8ca8d2f700eda99db9214fc2712b134@13.248.222.197:9735"
              }
            ]
          }
        },
        "swap_in": {
          "v1": {
            "fee_percent": 0.001
          }
        },
        "swap_out": {
          "v1": {
            "min_feerate_sat_byte": 0
          }
        },
        "mempool": {
          "v1": {
            "high_usage": true
          }
        }
      },
      "mainnet": {
        "version": 4,
        "latest_critical_version": 0,
        "trampoline": {
          "v1": {
            "fee_base_sat": 2,
            "fee_percent": 0.001,
            "hops_count": 5,
            "cltv_expiry": 143
          },
          "v2": {
            "attempts": [
              {
                "fee_base_sat": 0,
                "fee_percent": 0,
                "fee_per_millionths": 0,
                "cltv_expiry": 576
              },
              {
                "fee_base_sat": 1,
                "fee_percent": 0.0001,
                "fee_per_millionths": 100,
                "cltv_expiry": 576
              }
            ]
          }
        },
        "swap_in": {
          "v1": {
            "fee_percent": 0.001
          }
        },
        "swap_out": {
          "v1": {
            "min_feerate_sat_byte": 40
          }
        },
        "mempool": {
          "v1": {
            "high_usage": false
          }
        }
      }
    }
"""

@OptIn(ExperimentalTime::class)
fun runTest(timeout: Duration = 30.seconds, test: suspend CoroutineScope.() -> Unit) {
    runBlocking {
        withTimeout(timeout) {
            launch {
                test()
                cancel()
            }.join()
        }
    }
}